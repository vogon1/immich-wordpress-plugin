#!/usr/bin/env node
/**
 * Sync JSON translation files to match webpack build hash
 * 
 * This script copies JSON translation files generated by wp-cli to match
 * the webpack build hash. WordPress requires exact hash match:
 * {textdomain}-{locale}-{webpack-hash}.json
 */

const fs = require('fs');
const path = require('path');

// Read the webpack build hash from index.asset.php
const assetFile = path.join(__dirname, '../build/index.asset.php');
const assetContent = fs.readFileSync(assetFile, 'utf8');
const hashMatch = assetContent.match(/'version'\s*=>\s*'([^']+)'/);

if (!hashMatch) {
    console.error('❌ Could not find webpack hash in build/index.asset.php');
    process.exit(1);
}

const webpackHash = hashMatch[1];
console.log(`✓ Webpack hash: ${webpackHash}`);

// Get all .po files to determine available locales
const languagesDir = path.join(__dirname, '../languages');
const poFiles = fs.readdirSync(languagesDir).filter(f => f.endsWith('.po'));

const locales = poFiles.map(f => {
    const match = f.match(/gallery-for-immich-(.+)\.po$/);
    return match ? match[1] : null;
}).filter(Boolean);

console.log(`✓ Found locales: ${locales.join(', ')}`);

// For each locale, find the source JSON file and copy it to the webpack hash version
let copied = 0;
let errors = 0;

for (const locale of locales) {
    // Find any existing JSON file for this locale (regardless of hash)
    const jsonFiles = fs.readdirSync(languagesDir)
        .filter(f => f.startsWith(`gallery-for-immich-${locale}-`) && f.endsWith('.json'));
    
    if (jsonFiles.length === 0) {
        console.warn(`⚠️  No JSON file found for locale ${locale}`);
        continue;
    }
    
    // Use the first (or only) JSON file as source
    const sourceFile = path.join(languagesDir, jsonFiles[0]);
    const targetFile = path.join(languagesDir, `gallery-for-immich-${locale}-${webpackHash}.json`);
    
    // Copy the file to the new hash
    try {
        fs.copyFileSync(sourceFile, targetFile);
        console.log(`✓ Copied ${locale}: ${jsonFiles[0]} → gallery-for-immich-${locale}-${webpackHash}.json`);
        copied++;
        
        // Clean up old JSON files for this locale (keep only the new one)
        for (const oldFile of jsonFiles) {
            const oldFilePath = path.join(languagesDir, oldFile);
            if (oldFilePath !== targetFile) {
                fs.unlinkSync(oldFilePath);
                console.log(`  Deleted old: ${oldFile}`);
            }
        }
    } catch (err) {
        console.error(`❌ Error copying ${locale}: ${err.message}`);
        errors++;
    }
}

console.log(`\n✓ Done! Copied ${copied} translation files.`);
if (errors > 0) {
    console.error(`❌ ${errors} errors occurred.`);
    process.exit(1);
}
