name: Build & Release WordPress Plugin

on:
  push:
    tags:
      - "v*"   # Draait alleen bij tags zoals v1.0.0

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Haal code binnen
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: 'gallery-for-immich'

      # 2. (optioneel) Installeer PHP dependencies
      - name: Install PHP dependencies
        working-directory: gallery-for-immich
        run: |
          if [ -f composer.json ]; then
            composer install --no-dev --optimize-autoloader
          fi

      # 3. (optioneel) Installeer JS dependencies en bouw
      - name: Build JS/CSS
        working-directory: gallery-for-immich
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build
          fi

      # 4. Maak ZIP van de pluginmap (volgens .distignore)
      - name: Build ZIP
        run: |
          PLUGIN_SLUG="gallery-for-immich"
          
          # Kopieer alles naar een schone directory
          mkdir -p clean-build/${PLUGIN_SLUG}
          
          # Kopieer plugin files (niet de hele directory, anders krijgen we .git mee)
          rsync -av --exclude-from=${PLUGIN_SLUG}/.distignore ${PLUGIN_SLUG}/ clean-build/${PLUGIN_SLUG}/
          
          # Maak ZIP van de schone build
          cd clean-build
          zip -r ../${PLUGIN_SLUG}.zip ${PLUGIN_SLUG}
          cd ..
          
          # Verplaats naar dist folder
          mkdir dist
          mv ${PLUGIN_SLUG}.zip dist/

      # 5. Upload ZIP naar de GitHub Release
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
