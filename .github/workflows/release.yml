name: Build & Release WordPress Plugin

on:
  push:
    tags:
      - "v*"   # Draait alleen bij tags zoals v1.0.0

permissions:
  contents: write
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Haal code binnen
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          path: 'immich-gallery'

      # 2. (optioneel) Installeer PHP dependencies
      - name: Install PHP dependencies
        working-directory: immich-gallery
        run: |
          if [ -f composer.json ]; then
            composer install --no-dev --optimize-autoloader
          fi

      # 3. (optioneel) Installeer JS dependencies en bouw
      - name: Build JS/CSS
        working-directory: immich-gallery
        run: |
          if [ -f package.json ]; then
            npm ci
            npm run build
          fi

      # 4. Maak ZIP van de pluginmap (volgens .distignore)
      - name: Build ZIP
        run: |
          PLUGIN_SLUG="immich-gallery"
          mkdir dist
          
          # Lees .distignore en bouw exclusie lijst
          cd ${PLUGIN_SLUG}
          EXCLUDE_FILE="../exclude_list.txt"
          if [ -f .distignore ]; then
            # Converteer .distignore naar zip exclusie formaat
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip lege regels en comments
              [[ -z "$line" || "$line" =~ ^# ]] && continue
              # Verwijder leading slash en voeg plugin slug toe
              pattern="${line#/}"
              echo "${PLUGIN_SLUG}/${pattern}" >> "$EXCLUDE_FILE"
            done < .distignore
          fi
          cd ..
          
          # Maak ZIP met exclusies uit bestand
          if [ -f exclude_list.txt ]; then
            zip -r dist/${PLUGIN_SLUG}.zip ${PLUGIN_SLUG} -x@exclude_list.txt
          else
            zip -r dist/${PLUGIN_SLUG}.zip ${PLUGIN_SLUG}
          fi

      # 5. Upload ZIP naar de GitHub Release
      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
